obront

high

# _getInterest() function uses block.timestamp instead of the inputted timestamp

## Summary

The `_getInterest()` function takes a timestamp as input. However, in a crucial check in the function, it uses `block.timestamp` instead. The result is that other functions expecting accurate interest amounts will receive incorrect values.

## Vulnerability Detail

The `_getInterest()` function takes a lien and a timestamp as input. The intention is for it to calculate the amount of time that has passed in the lien (`delta_t`) and multiply this value by the rate and the amount to get the interest generated by this timestamp.

However, the function uses the following check regarding the timestamp:

```solidity
if (block.timestamp >= lien.start + lien.duration) {
  delta_t = uint256(lien.start + lien.duration - lien.last);
} 
```

Because this check uses `block.timestamp` before returning the maximum interest payment, the function will incorrectly determine which path to take, and return an incorrect interest value.

## Impact

There are two negative consequences that can come from this miscalculation:

- if the function is called when the lien is over (`block.timestamp >= lien.start + lien.duration`) to check an interest amount from a timestamp during the lien, it will incorrectly return the maximum interest value
- If the function is called when the lien is active for a timestamp long after the lien is over, it will skip the check to return maximum value and return the value that would have been generated if interest kept accruing indefinitely (using `delta_t = uint256(timestamp.safeCastTo32() - lien.last);`)

This `_getInterest()` function is used in many crucial protocol functions (`_getOwed()`, `calculateSlope()`, `changeInSlope()`, `getTotalDebtForCollateralToken()`), so these incorrect values can have surprising and unexpected negative impacts on the protocol.

## Code Snippet

https://github.com/sherlock-audit/2022-10-astaria/blob/main/src/LienToken.sol#L177-L196

## Tool used

Manual Review

## Recommendation

Change `block.timestamp` to `timestamp` so that the if statement checks correctly.